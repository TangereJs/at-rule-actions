<!--
`at-rule-actions` is an element for specifying actions

'config' property specifies the configuration for available actions

'value' property holds the specified actions. It can be used to provide initial actions.

'schema' property is used to generate the 'config' based on 'at-core-form's' json schmea

  How to specify 'config'

  There are four available actions to be specified: alert, update field's value, copy field's value to another field and set field's state
  config = {
  // specification for alert action
  "alert": { // action's name
    label: "Show alert" // action's label
  },
  // specification for update field action
  "updateField": {
    label: "Update Field",
    fields: [{
      label: "<field-label>", // field label
      name: "<field-name>", // field name
      updateTo: "value" // field will be updated with value that user types
    },{
      label: "<field-label>" // field label
      name: "<field-name>", // field name
      updateTo: "values", // field will be updated with predefined values specified in values property
      values: [{
        label: "<value-label>",
        name: "<value-value"
      }]
    }]
  },
  // specification for copy field value action
  "copyFieldValue": { // action name
    label: "Copy Field Value", // action label
    fields: [{
      label: "<field-label", // source field label
      name: "<field-name>", // source field name
      copyTo: [{
        label: "<field-label>", // destination field label
        name: "<field-name>" // destination field name
      }]
    }]
  },
  // specification for set field state action
  "setFieldState":{
    label: "Set Field State",
    fields:[
      label: "<field-label", // source field label
      name: "<field-name>", // source field name
      states: [{
        label: "Optional",
        name: "optional"
      },{
        label: "Required",
        name: "required"
      },{
        label: "Disabled",
        name: "disabled"
      },{
        label: "Hidden",
        name: "hidden"
      }]
    ]
  }
};

How to specify value

value = [
  {
    actionName: 'alert',
    message: "<message-text>"
  },
  {
    actionName: 'updateField',
    fieldName: "<field-name>",
    updateTo: "<value-to-update-to>"
  },
  {
    actionName: 'copyFieldValue',
    fieldName: "<source-field-name>",
    copyTo: "<destination-field-name>"
  },
  {
    actionName: 'setFieldState',
    fieldName: "<field-name>",
    state: "<state-name>" // one of [optional, required, disabled or hidden]
  }
];
-->
<link rel="import" href="../tangere/tangere.html">
<link rel="import" href="../at-theme/at-theme.html">
<link rel="import" href="../at-i18n/at-i18n-behavior.html">
<link rel="import" href="../at-elements/at-designer-elements.html">
<link rel="import" href="../at-carbon-icon-button/at-carbon-icon-button.html" />
<link rel="import" href="../at-form-lookup/at-form-lookup.html" />
<link rel="import" href="../at-form-textarea/at-form-textarea.html" />
<link rel="import" href="at-rule-actions-styles.html" />

<dom-module id="at-rule-actions">
  <template>
    <style include="at-rule-actions-styles">
      :host {
        display: block;
        box-sizing: border-box;
      }

    </style>
    <h4 hidden$="[[hideLabel]]" class="actions-title">{{label}}</h4>
    <div id="actionsHtmlContainer"></div>
  </template>
  <script>
    'use strict';
    Polymer({
      is: 'at-rule-actions',
      properties: {
        schema: {
          type: Object,
          value: function() {
            return {};
          },
          observer: 'schemaChanged'
        },
        config: {
          type: Object,
          value: function() {
            return {};
          },
          observer: 'configChanged'
        },
        value: {
          type: Array,
          value: function() {
            return [];
          },
          observer: 'valueChanged'
        },
        disabled: {
          type: Boolean,
          value: false,
          observer: 'disabledChanged'
        },
        label: {
          type: String,
          value: 'Do these actions...'
        },
        hideLabel: {
          type: Boolean,
          value: false
        },
      },

      ready: function() {
        this._isReady = true;
        var self = this;

        this.$.actionsHtmlContainer.addEventListener('value-changed', function(event) {
          event.stopPropagation();
          var target = event.target;
          console.log('value-changed captured');
          // if (target.is !== undefined) {
          //   return;
          // }
          var updatePath = target.getAttribute('data-update-path');
          var value = target.value;

          self.set(updatePath, value, self.value);
          self.fire('value-changed', {
            value: self.value
          }, { bubbles: false});
        });
      },
      schemaChanged: function(newValue, oldValue) {
        if (newValue.properties) {
          var t_config = this.schemaToConfig(newValue);
          this.config = t_config;
        }
      },
      configChanged: function(newValue, oldValue) {
        if (!this._isReady) {
          return;
        }

        this._rebuildActionsHtml();
      },
      valueChanged: function(newValue, oldValue) {
        if (!this._isReady || !newValue) {
          return;
        }

        this._rebuildActionsHtml();
      },
      _rebuildActionsHtml: function() {
        Polymer.dom(this.$.actionsHtmlContainer).innerHTML = '';
        this.buildActionsHtml(this.$.actionsHtmlContainer, this.config, this.value);
        this.disabledChanged(this.disabled, this.disabled);
      },
      disabledChanged: function(newValue, oldValue) {
        var
          selectIndex,
          selectElement,
          selectElements = [],
          inputIndex,
          inputElement,
          inputElements = [],
          aIndex,
          aElement,
          aElements = [],
          textAreaIndex,
          textAreaElement,
          textAreaElements = [],
          tmp;
        var container = this.$.actionsHtmlContainer;

        var classNames = [ '.-ara-action-select', '.-ara-message', '.-ara-field-name', '.-ara-update-to', '.-ara-copy-to', '.-ara-state',  '.-ara-errormessage', '.span-text', 'at-carbon-icon-button' ];

        classNames.forEach(function (className, index) { 
          tmp = Polymer.dom(container).querySelectorAll(className);
          
          tmp.forEach(function(element, index) { 
            element.disabled = newValue;

            if (className === ".span-text") {
              if (newValue) {
                element.setAttribute('disabled', newValue);
              } else {
                element.removeAttribute('disabled', newValue);
              }
            }
          });
        });
      },

      schemaToConfig: function(schema) {
        var stateOptions = [{
          label: "Optional",
          name: "optional"
        }, {
          label: "Required",
          name: "required"
        }, {
          label: "Hidden",
          name: "hidden"
        }, {
          label: "Disabled",
          name: "disabled"
        }];

        var result = {
          alert: {
            label: "Show alert"
          },
          updateField: {
            label: "Update Field Value",
            fields: []
          },
          copyFieldValue: {
            label: "Copy Field Value",
            fields: []
          },
          setFieldState: {
            label: "Set Field State",
            fields: []
          },
          setFieldError: {
            label: "Set Field Error",
            fields: []
          }
        };

        var properties = schema.properties;
        var propName;
        var propTitle;
        var propDef;
        var updateFieldOption;
        var setFieldStateOption;
        var copyFieldValueOption;
        var setFieldErrorOption;
        var propType;
        var value;

        for (propName in properties) {
          propDef = properties[propName];
          propType = this.getPropertyType(propDef);
          propTitle = propDef.title ? propDef.title : this.capitalize(propName);

          setFieldErrorOption = {
            label: this.capitalize(propTitle),
            name: propName
          }

          switch (propType) {
            case "string":
            case "number":
            case "password":
            case "lookup":
            case "textarea":
            case "code":
            case "marked":
            case "date":
            case "time":
            case "datetime":
            case "daterange":
            case "file":
            case "image":

              updateFieldOption = {
                label: this.capitalize(propTitle + " to"),
                name: propName,
                updateTo: "text"
              };

              break;
            case "bool":
            case "boolean":
            case "toggle":
              var booleanOptions = [{
                name: "true",
                label: "true"
              }, {
                name: "false",
                label: "false"
              }];

              updateFieldOption = {
                label: this.capitalize(propTitle + " to"),
                name: propName,
                updateTo: "values",
                values: booleanOptions
              };

              break;
            case "enum":
            case "radio":
              var condConfOptions;
              if (propDef.options) {
                condConfOptions = propDef.options;
              } else if (propDef.xvaluelist && propDef.xvaluelist.length !== undefined) {
                condConfOptions = [];
                if (this.isArray(propDef.xvaluelist)) {
                  condConfOptions = propDef.xvaluelist;
                } else {
                  var valueListItems = propDef.xvaluelist.split(',');
                  for (var vlItemsIndex = 0; vlItemsIndex < valueListItems.length; vlItemsIndex += 1) {
                    var trimmedValue = valueListItems[vlItemsIndex].trim();
                    var ccOption = {
                      label: trimmedValue,
                      name: trimmedValue
                    };
                    condConfOptions.push(ccOption);
                  }
                }
              } else if (propDef.enum && propDef.enum.length !== undefined) {
                // enum is an array of strings
                condConfOptions = [];
                var eIndex;
                var eLen = propDef.enum.length;
                for (var eIndex = 0; eIndex < eLen; eIndex++) {
                  var eValue = propDef.enum[eIndex];
                  var eOption = false;
                  if (eValue.title && e.Value.value) {
                    eOption = {
                      label: evalue.title,
                      name: eValue.value
                    };
                  } else {
                    var eTrimValue = eValue.trim();
                    eOption = {
                      label: eTrimValue,
                      name: eTrimValue
                    };
                  }
                  condConfOptions.push(eOption);
                }
              }

              updateFieldOption = {
                label: this.capitalize(propTitle + " to"),
                name: propName,
                updateTo: "values",
                values: condConfOptions
              };

              break;
          }
          result.updateField.fields.push(updateFieldOption);

          // any field type can have its value copied to another field
          var copyFieldValueField = this.getCopyFieldValueFieldFor(propName, properties);
          if (copyFieldValueField.copyTo.length > 0) {
            // if there is at least one copy target add field to copyFieldValue action
            result.copyFieldValue.fields.push(copyFieldValueField);
          }

          // any field type can have its state set
          setFieldStateOption = {
            label: propTitle,
            name: propName,
            states: stateOptions
          };

          result.setFieldState.fields.push(setFieldStateOption);
          result.setFieldError.fields.push(setFieldErrorOption);
        }
        return result;
      },

      // ----------------------------------------
      // calculates what is property's type
      // ----------------------------------------
      getPropertyType: function(propDef) {
        var result = propDef.type;

        if (result === "boolean" && propDef.hasOwnProperty('xtype') && propDef.xtype !== "") {
          result = propDef.xtype;
        }

        if (result === "string" && propDef.hasOwnProperty('xtype') && propDef.xtype !== "") {
          result = propDef.xtype;
          if (result.indexOf('-') != -1) {
            var indexOfDash = result.indexOf('-');
            result = result.slice(0, indexOfDash);
          }
        }

        if (result === "string" && (!propDef.hasOwnProperty('xtype') || propDef.xtype === '') && propDef.hasOwnProperty('enum') && this.isArray(propDef.enum)) {
          result = "enum";
        }

        return result;
      },
      isArray: function(obj) {
        return Object.prototype.toString.call(obj) === "[object Array]";
      },

      // ------------------------------
      // capitalizes the first letter or a word
      // ------------------------------
      capitalize: function(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      },

      // ----------------------------------------
      // for given property name and properties creates a copyFieldValue action
      // entry for its fields property
      // ----------------------------------------
      getCopyFieldValueFieldFor: function(propName, properties) {
        var result = {
          label: this.capitalize(propName + " to"),
          name: propName,
          copyTo: []
        };

        var
          property,
          propertyTitle,
          condConf = properties[propName];
        if (condConf.title) {
          result.label = condConf.title;
        }

        for (property in properties) {
          if (propName !== property) { // if names are different
            var propertyConf = properties[property];
            var isTarget = this.isCopyTarget(condConf, propertyConf);
            if (isTarget) {
              propertyTitle = propertyConf.title ? propertyConf.title : this.capitalize(property);
              result.copyTo.push({
                label: propertyTitle,
                name: property
              });
            }
          }
        }

        return result;
      },

      /**
       * Determines whether targetConf can be a copy target for condConf
       * @return true if it can, false otherwise
       */
      isCopyTarget: function(condConf, targetConf) {

        if (condConf.type !== targetConf.type) {
          // if both have different type they are not compatible
          return false;
        }

        if (condConf.xtype === undefined && targetConf.xtype === undefined) {
          // if both are of the same type and do not have xtype and they are compatible
          return true;
        }

        if ((condConf.xtype === undefined && targetConf.xtype !== undefined) || (condConf.xtype !== undefined && targetConf.xtype === undefined)) {
          // if both have same type but one has xtype and other doesn't they are not compatible
          return false;
        }

        if (condConf.xtype !== targetConf.xtype) {
          // if both have same type but different xtypes they are not compatible
          return false;
        }

        // at this point both have the same type and same xtype

        if (condConf.xtype === 'enum') {
          // compare xvaluelists
          if (condConf.xvaluelist === undefined || targetConf.xvaluelist === undefined || condConf.xvaluelist !== targetConf.xvaluelist) {
            // if any of the two doesn't have xvaluelist or xvaluelists are different they are not compatible
            return false;
          }
        } else if (condConf.xtype === 'lookup') {
          if (condConf.xurl === undefined || targetConf.xurl === undefined || condConf.xurl !== targetConf.xurl) {
            // if any of the two doesn't have xurl or xurls are different they are not compatible
            return false;
          }
        } else {
          // xtype is not recognized; return false
          return false;
        }

        // source and target are compatible; return true
        return true;
      },

      addAction: function(actionData) {
        this.value.push(actionData);
        this.fire('value-changed', {
          value: this.value
        });
      },
      removeAction: function(path) {
        var removeIndex = parseInt(path);
        var i, length = this.value.length;

        this.value.splice(removeIndex, 1);

        for (i = removeIndex + 1; i < length; i += 1) {
          var oldPath = (i).toString();
          var newPath = (i - 1).toString();
          var selector = '[data-update-path=\'' + oldPath + '\']';
          var element = Polymer.dom(this.$.actionsHtmlContainer).querySelector(selector);
          this.updatePath(element, oldPath, newPath);
        }

        this.fire('value-changed', {
          value: this.value
        });
      },
      updatePath: function(element, oldPath, newPath) {
        Polymer.dom(element).setAttribute('data-update-path', newPath);
        var subfields = Polymer.dom(element).querySelector('.-ara-subfields');
        Polymer.dom(subfields).setAttribute('data-update-path', newPath);

        var actionSelect = Polymer.dom(element).querySelector('.-ara-action-select');
        this.updateDataUpdatePathAttr(actionSelect, oldPath, newPath);

        var message = Polymer.dom(element).querySelector('.-ara-message');
        if (message) {
          this.updateDataUpdatePathAttr(message, oldPath, newPath);
        }
        var fieldNameSelect = Polymer.dom(element).querySelector('.-ara-field-name');
        if (fieldNameSelect) {
          this.updateDataUpdatePathAttr(fieldNameSelect, oldPath, newPath);

          var updateTo = Polymer.dom(element).querySelector('.-ara-update-to');
          if (updateTo) {
            this.updateDataUpdatePathAttr(updateTo, oldPath, newPath)
          }

          var copyTo = Polymer.dom(element).querySelector('.-ara-copy-to');
          if (copyTo) {
            this.updateDataUpdatePathAttr(copyTo, oldPath, newPath)
          }

          var state = Polymer.dom(element).querySelector('.-ara-state');
          if (state) {
            this.updateDataUpdatePathAttr(state, oldPath, newPath)
          }
        }
      },
      updateDataUpdatePathAttr: function(element, oldPath, newPath) {
        var updatePath = element.getAttribute('data-update-path');
        updatePath = updatePath.replace(oldPath, newPath);
        Polymer.dom(element).setAttribute('data-update-path', updatePath);
      },
      buildActionsHtml: function(htmlContainer, config, data) {
        var self = this;
        // build the container for the actions
        var actionsContainer = document.createElement('div');
        Polymer.dom(htmlContainer).appendChild(actionsContainer);
        Polymer.dom(actionsContainer).classList.add('-ara-actions');

        var i, actionData, actionConfig, length = data.length,
          path;
        for (i = 0; i < length; i++) {
          actionData = data[i];
          path = (i).toString();
          this.buildActionHtml(actionsContainer, config, actionData, path);
        }

        // build the container for the add action button
        var buttonContainer = document.createElement('div');
        Polymer.dom(htmlContainer).appendChild(buttonContainer);
        Polymer.dom(buttonContainer).classList.add('-ara-action-buttons');
        // create the add action button
        var addActionButton = document.createElement('at-carbon-icon-button');
        addActionButton.icon = "now:plus";        
        Polymer.dom(buttonContainer).appendChild(addActionButton);

        addActionButton.addEventListener('click', function(event) {
          var _container = actionsContainer;
          var _config = config
          var newAction = {
            actionName: 'alert',
            message: ''
          };
          var path = (self.value.length).toString();
          self.buildActionHtml(_container, _config, newAction, path);
          self.addAction(newAction);
        });
      },
      buildActionHtml: function(htmlContainer, config, data, path) {
        var self = this;
        var actionHtml = document.createElement('div');
        Polymer.dom(htmlContainer).appendChild(actionHtml);
        Polymer.dom(actionHtml).setAttribute('data-update-path', path);
        Polymer.dom(actionHtml).classList.add('-ara-action');

        var actionSelect = this.createActionSelect(config, data, path);
        Polymer.dom(actionHtml).appendChild(actionSelect);

        actionSelect.addEventListener('value-changed', function(event) {
          var _container = actionHtml;
          var _config = config;
          var subFieldsContainer = Polymer.dom(_container).querySelector('.-ara-subfields');
          Polymer.dom(subFieldsContainer).innerHTML = '';

          var target = event.target;
          var actionName = target.value;
          var actionConfig = _config[actionName];
          var path = _container.getAttribute('data-update-path');
          var data = self.getDefaultValue(actionName, actionConfig);
          self.set(path, data, self.value);

          if (actionName === 'alert') {
            self.createAlertHtml(subFieldsContainer, data, path);
          } else if (actionName === 'updateField') {
            self.createUpdateFieldHtml(subFieldsContainer, actionConfig, data, path);
          } else if (actionName === 'copyFieldValue') {
            self.createCopyFieldValueHtml(subFieldsContainer, actionConfig, data, path);
          } else if (actionName === 'setFieldState') {
            self.createSetFieldStateHtml(subFieldsContainer, actionConfig, data, path);
          } else if (actionName === 'setFieldError') {
            self.createSetFieldErrorHtml(subFieldsContainer, actionConfig, data, path);
          }

          self._handleFormElementValueChanged(event);
        });

        var subFieldsContainer = document.createElement('div');
        Polymer.dom(subFieldsContainer).classList.add('-ara-subfields');
        Polymer.dom(subFieldsContainer).setAttribute('data-update-path', path);
        Polymer.dom(actionHtml).appendChild(subFieldsContainer);
        var actionName = actionSelect.value;
        var actionConfig = config[actionName];

        if (actionName === 'alert') {
          this.createAlertHtml(subFieldsContainer, data, path);
        } else if (actionName === 'updateField') {
          this.createUpdateFieldHtml(subFieldsContainer, actionConfig, data, path);
        } else if (actionName === 'copyFieldValue') {
          this.createCopyFieldValueHtml(subFieldsContainer, actionConfig, data, path);
        } else if (actionName === 'setFieldState') {
          this.createSetFieldStateHtml(subFieldsContainer, actionConfig, data, path);
        } else if (actionName === 'setFieldError') {
          this.createSetFieldErrorHtml(subFieldsContainer, actionConfig, data, path);
        }

        var removeButton = document.createElement('at-carbon-icon-button');
        removeButton.icon = "now:trash";
        removeButton.color = "red";
        Polymer.dom(removeButton).classList.add('remove-action')
        Polymer.dom(actionHtml).appendChild(removeButton);

        removeButton.addEventListener('click', function(event) {
          var target = event.currentTarget;
          var actionContainer = Polymer.dom(target).parentNode;
          var updatePath = actionContainer.getAttribute('data-update-path');
          var actionsContainer = Polymer.dom(actionContainer).parentNode;

          Polymer.dom(actionsContainer).removeChild(actionContainer);

          self.removeAction(updatePath);
        });
      },
      createActionSelect: function(config, data, path) {
        var select = document.createElement('at-form-lookup');
        Polymer.dom(select).classList.add('-ara-action-select');
        Polymer.dom(select).setAttribute('data-update-path', this.createPath(path, 'actionName'));

        var actionName, actionConfig, actionLabel, selectOption;
        var xvaluelist = [];
        for (actionName in config) {
          actionConfig = config[actionName];          
          xvaluelist.push({ title: actionConfig.label, value: actionName });
        }
        select.xvaluelist = xvaluelist;
        select.value = data.actionName;

        return select;
      },
      createSelectOption: function(value, label, selected) {
        var option = document.createElement('option');

        option.value = value;
        option.text = label;
        option.selected = selected;

        return option;
      },
      createAlertHtml: function(htmlContainer, data, path) {
        var textarea = document.createElement('at-form-textarea');
        Polymer.dom(textarea).setAttribute('data-update-path', this.createPath(path, 'message'));
        Polymer.dom(textarea).classList.add('-ara-message');
        textarea.value = data.message;
        Polymer.dom(htmlContainer).appendChild(textarea);
        textarea.addEventListener('value-changed', this._handleFormElementValueChanged.bind(this));
      },
      createUpdateFieldHtml: function(htmlContainer, config, data, path) {
        var self = this;
        var fieldSelect = this.createFieldSelect(config.fields, data.fieldName, this.createPath(path, 'fieldName'));
        Polymer.dom(fieldSelect).classList.add('-ara-field-name');
        Polymer.dom(htmlContainer).appendChild(fieldSelect);

        var fieldConfig = this.findFieldConfig(config.fields, data.fieldName);
        var updateToHtml = this.createUpdateToHtml(htmlContainer, fieldConfig, data, path);

        fieldSelect.addEventListener('value-changed', function(event) {
          var _config = config;
          var _container = htmlContainer;
          var target = event.target;
          var fieldName = target.value;
          var fieldConfig = self.findFieldConfig(_config.fields, fieldName);
          var path = _container.getAttribute('data-update-path');
          var actionData = self.get(path, self.value);
          self.createUpdateToHtml(_container, fieldConfig, actionData, path);

          self._handleFormElementValueChanged(event);
        });
      },
      createUpdateToHtml: function(htmlContainer, fieldConfig, actionData, path) {
        var prevUpdateTo = Polymer.dom(htmlContainer).querySelector('.-ara-update-to');
        if (prevUpdateTo) {
          Polymer.dom(htmlContainer).removeChild(prevUpdateTo);
        }
        var updatePath = this.createPath(path, 'updateTo');
        if (this.schema.properties !== undefined) {
          var displayType = this.getPropertyType(this.schema.properties[fieldConfig.name]);
          var propDef = this.schema.properties[fieldConfig.name];

          switch (displayType) {
            case "code":
              var htmlElem = document.createElement('at-form-codemirror');
              break;
            case "date":
            case "time":
            case "datetime":
              var htmlElem = document.createElement('at-form-date');
              htmlElem.xtype = displayType;
              break;
            case "daterange":
              var htmlElem = document.createElement('at-form-daterange');
              break;
            case "file":
              var htmlElem = document.createElement('at-form-file');
              break;
            case "image":
              var htmlElem = document.createElement('at-form-image');
              break;
            case "lookup":
              var htmlElem = document.createElement('at-form-lookup');
              break;
            case "marked":
              var htmlElem = document.createElement('at-form-markdown');
              break;
            case "number":
              var htmlElem = document.createElement('at-form-number');
              break;
            case "password":
              var htmlElem = document.createElement('at-form-password');
              break;
            case "string":
              var htmlElem = document.createElement('at-form-text');
              break;
            case "textarea":
              var htmlElem = document.createElement('at-form-textarea');
              break;
            case "boolean":
            case "toggle":
              var htmlElem = document.createElement('at-form-checkbox');
              if (displayType === "toggle") {
                htmlElem.xtype = displayType;
              }
              break;
            case "enum":
              var htmlElem = document.createElement('at-form-lookup');
              htmlElem.xvaluelist = propDef.xvaluelist;
              break;
            case "radio":
              var htmlElem = document.createElement('at-form-radio');
              htmlElem.xvaluelist = propDef.xvaluelist;
              break;
          }
          Polymer.dom(htmlElem).classList.add('-ara-update-to');
          Polymer.dom(htmlElem).classList.add('inline-element');
          Polymer.dom(htmlElem).setAttribute('data-update-path', updatePath);
          htmlElem.value = actionData.updateTo;
          Polymer.dom(htmlContainer).appendChild(htmlElem);

          var self = this;
          htmlElem.addEventListener('value-changed', this._handleFormElementValueChanged.bind(this));

        } else {
          if (fieldConfig.updateTo === "text") {
            var inputText = document.createElement('input');
            Polymer.dom(inputText).setAttribute('type', 'text');
            Polymer.dom(inputText).classList.add('-ara-update-to');
            Polymer.dom(inputText).setAttribute('data-update-path', updatePath);
            inputText.value = actionData.updateTo;
            Polymer.dom(htmlContainer).appendChild(inputText);
          } else if (fieldConfig.updateTo === "values") {
            var valuesSelect = this.createFieldSelect(fieldConfig.values, actionData.updateTo, updatePath);
            Polymer.dom(valuesSelect).classList.add('-ara-update-to');
            Polymer.dom(htmlContainer).appendChild(valuesSelect);
            this.set(updatePath, valuesSelect.value, this.value);
          }
        }

      },
      createCopyFieldValueHtml: function(htmlContainer, config, data, path) {
        var self = this;

        var fieldSelect = this.createFieldSelect(config.fields, data.fieldName, this.createPath(path, 'fieldName'));
        Polymer.dom(fieldSelect).classList.add('-ara-field-name');
        Polymer.dom(htmlContainer).appendChild(fieldSelect);

        fieldSelect.addEventListener('value-changed', function(event) {
          var _config = config;
          var _container = htmlContainer;
          var path = _container.getAttribute('data-update-path');
          var updatePath = self.createPath(path, 'copyTo');

          var target = event.target;
          var fieldName = target.value;
          var selectedField = self.findFieldConfig(_config.fields, fieldName);
          var data = self.get(path, self.value);

          self.createCopyToHtml(_container, selectedField, data, updatePath);
          self._handleFormElementValueChanged(event);
        });

        var fieldName = data.fieldName;
        var selectedField = this.findFieldConfig(config.fields, fieldName);

        if (selectedField === undefined) { return; }
        this.createCopyToHtml(htmlContainer, selectedField, data, this.createPath(path, 'copyTo'));
      },
      createCopyToHtml: function(htmlContainer, field, data, path) {
        var prevCopyTo = Polymer.dom(htmlContainer).querySelector('.-ara-copy-to');
        if (prevCopyTo) {
          Polymer.dom(htmlContainer).removeChild(prevCopyTo);
        }

        var copyToSelect = this.createFieldSelect(field.copyTo, data.copyTo, path);
        Polymer.dom(copyToSelect).classList.add('-ara-copy-to');
        Polymer.dom(htmlContainer).appendChild(copyToSelect);
        this.set(path, copyToSelect.value, this.value);
        copyToSelect.addEventListener('value-changed', this._handleFormElementValueChanged.bind(this));
      },
      createSetFieldStateHtml: function(htmlContainer, config, data, path) {
        var fieldSelect = this.createFieldSelect(config.fields, data.fieldName, this.createPath(path, 'fieldName'));
        Polymer.dom(fieldSelect).classList.add('-ara-field-name');
        Polymer.dom(htmlContainer).appendChild(fieldSelect);
        fieldSelect.addEventListener('value-changed', this._handleFormElementValueChanged.bind(this));

        var fieldName = data.fieldName;
        var selectedField = this.findFieldConfig(config.fields, fieldName);
        var stateSelect = this.createFieldSelect(selectedField.states, data.state, this.createPath(path, 'state'));
        Polymer.dom(stateSelect).classList.add('-ara-state');
        Polymer.dom(htmlContainer).appendChild(stateSelect);
        stateSelect.addEventListener('value-changed', this._handleFormElementValueChanged.bind(this));
      },
      createFieldSelect: function(fields, fieldName, path) {
        var fieldsSelect = document.createElement('at-form-lookup');
        Polymer.dom(fieldsSelect).classList.add('inline-element');
        Polymer.dom(fieldsSelect).setAttribute('data-update-path', path);

        var i, length = fields.length, field;
        var xvaluelist = [];
        for (i = 0; i < length; i++) {
          field = fields[i];
          xvaluelist.push({ title: field.title || field.label, value: field.value || field.name });
        }
        fieldsSelect.xvaluelist = xvaluelist;
        fieldsSelect.value = fieldName;

        return fieldsSelect;
      },
      createSetFieldErrorHtml: function(htmlContainer, config, data, path) {
        var textarea = document.createElement('at-form-textarea');
        Polymer.dom(textarea).setAttribute('data-update-path', this.createPath(path, 'errorMessage'));
        Polymer.dom(textarea).classList.add('-ara-errormessage');
        textarea.value = data.errorMessage;
        Polymer.dom(htmlContainer).appendChild(textarea);
        textarea.addEventListener('value-changed', this._handleFormElementValueChanged.bind(this));

        var spanText = document.createElement('span');
        Polymer.dom(spanText).innerHTML = 'on';
        Polymer.dom(spanText).classList.add('span-text');
        Polymer.dom(htmlContainer).appendChild(spanText);

        var fieldSelect = this.createFieldSelect(config.fields, data.fieldName, this.createPath(path, 'fieldName'));
        Polymer.dom(fieldSelect).classList.add('-ara-field-name');
        Polymer.dom(htmlContainer).appendChild(fieldSelect);
        fieldSelect.addEventListener('value-changed', this._handleFormElementValueChanged.bind(this));
      },

      _handleFormElementValueChanged: function(event) {
        event.stopPropagation();
        var target = event.target;
        if (target.is === undefined || target.is === "") {
          return;
        }

        var updatePath = target.getAttribute('data-update-path');
        var value = target.value;

        this.set(updatePath, value, this.value);
        this.fire('value-changed', 
          { value: this.value }, 
          { bubbles: false}
        );
      },

      createPath: function(previousPath, step) {
        var result = '';
        if (previousPath === '') {
          result = step;
        } else {
          result = previousPath + "." + step;
        }

        return result;
      },
      findFieldConfig: function(fields, fieldName) {
        var i, length = fields.length,
          field, result = fields[0];

        for (i = 1; i < length; i += 1) {
          field = fields[i];
          if (field.name === fieldName) {
            result = field;
            break;
          }
        }

        return result;
      },
      getDefaultValue: function(actionName, actionConfig) {
        var result = {
            actionName: actionName
          },
          field = actionConfig.fields ? actionConfig.fields[0] : {};

        if (actionName === 'alert') {
          result.message = '';
        } else if (actionName === 'updateField') {
          result.fieldName = field.name;
          result.updateTo = '';
          if (field.updateTo === 'values' && field.values !== undefined && field.values.length > 0) {
            result.updateTo = field.values[0].name;
          }
        } else if (actionName === 'copyFieldValue' && field !== undefined) {
          result.fieldName = field.name;
          result.copyTo = "";
          if (field.copyTo !== undefined && field.copyTo.length > 0) {
            result.copyTo = field.copyTo[0].name;
          }
        } else if (actionName === 'setFieldState') {
          result.fieldName = field.name;
          result.state = field.states[0].name;
        } else if (actionName === 'setFieldError') {
          result.fieldName = field.name;
          result.errorMessage = '';
        }

        return result;
      }
    });
  </script>
</dom-module>
